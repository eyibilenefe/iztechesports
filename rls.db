-- =================================================================
-- SATIR SEVİYESİ GÜVENLİK (ROW-LEVEL SECURITY - RLS) POLİTİKALARI
-- Bu sorgular, veritabanı tablolarınızın güvenliğini sağlamak için kullanılır.
-- Her bir politika bloğunu Supabase SQL Editör'ünde çalıştırabilirsiniz.
-- =================================================================

-- ÖNEMLİ: Bir tabloya politika eklemeden önce RLS'yi o tablo için aktif hale getirmelisiniz.

---
-- PROFILES Tablosu Politikaları
---
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Herkes profilleri görebilir."
ON public.profiles FOR SELECT
USING (true);

CREATE POLICY "Kullanıcılar kendi profillerini güncelleyebilir."
ON public.profiles FOR UPDATE
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

---
-- TEAMS Tablosu Politikaları
---
ALTER TABLE public.teams ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Herkes takımları görebilir."
ON public.teams FOR SELECT
USING (true);

CREATE POLICY "Giriş yapmış kullanıcılar takım oluşturabilir."
ON public.teams FOR INSERT
WITH CHECK (auth.role() = 'authenticated' AND auth.uid() = creator_user_id);

CREATE POLICY "Takım kurucusu takımı güncelleyebilir."
ON public.teams FOR UPDATE
USING (auth.uid() = creator_user_id)
WITH CHECK (auth.uid() = creator_user_id);
-- Not: Daha karmaşık "kaptan" rolleri için Supabase Functions kullanmak daha esnek bir çözüm olabilir.

CREATE POLICY "Takım kurucusu takımı silebilir."
ON public.teams FOR DELETE
USING (auth.uid() = creator_user_id);


---
-- TEAM_MEMBERS Tablosu Politikaları
---
ALTER TABLE public.team_members ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Herkes takım üyelerini görebilir."
ON public.team_members FOR SELECT
USING (true);

-- Not: Üye ekleme/çıkarma işlemleri genellikle takım kaptanının yetkisinde olmalıdır.
-- Bu, Supabase Functions (Edge Functions) kullanılarak daha güvenli bir şekilde yönetilebilir.
-- Örnek bir basit politika aşağıdadır:
CREATE POLICY "Takım üyeleri kendi üyeliklerini silebilir."
ON public.team_members FOR DELETE
USING (auth.uid() = user_id);


---
-- LOBBIES Tablosu Politikaları
---
ALTER TABLE public.lobbies ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Herkes lobileri görebilir."
ON public.lobbies FOR SELECT
USING (true);

CREATE POLICY "Giriş yapmış kullanıcılar lobi oluşturabilir."
ON public.lobbies FOR INSERT
WITH CHECK (auth.role() = 'authenticated' AND auth.uid() = creator_user_id);

CREATE POLICY "Lobi sahibi lobiyi güncelleyebilir."
ON public.lobbies FOR UPDATE
USING (auth.uid() = creator_user_id)
WITH CHECK (auth.uid() = creator_user_id);

CREATE POLICY "Lobi sahibi lobiyi silebilir."
ON public.lobbies FOR DELETE
USING (auth.uid() = creator_user_id);


---
-- LOBBY_PARTICIPANTS Tablosu Politikaları
---
ALTER TABLE public.lobby_participants ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Herkes lobi katılımcılarını görebilir."
ON public.lobby_participants FOR SELECT
USING (true);

CREATE POLICY "Giriş yapmış kullanıcılar lobilere katılabilir."
ON public.lobby_participants FOR INSERT
WITH CHECK (auth.role() = 'authenticated' AND auth.uid() = user_id);

CREATE POLICY "Kullanıcılar kendi katılımlarını silebilir."
ON public.lobby_participants FOR DELETE
USING (auth.uid() = user_id);

CREATE POLICY "Sistem lobi katılımcısı ekleyebilir."
ON public.lobby_participants FOR INSERT
WITH CHECK (auth.role() = 'authenticated');


---
-- LOBBY_INVITATIONS Tablosu Politikaları
---
ALTER TABLE public.lobby_invitations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Kullanıcılar kendi davetlerini görebilir."
ON public.lobby_invitations FOR SELECT
USING (auth.uid() = invited_user_id OR auth.uid() = inviter_user_id);

CREATE POLICY "Giriş yapmış kullanıcılar davet gönderebilir."
ON public.lobby_invitations FOR INSERT
WITH CHECK (auth.role() = 'authenticated' AND auth.uid() = inviter_user_id);

CREATE POLICY "Davet edilen kullanıcı daveti yanıtlayabilir."
ON public.lobby_invitations FOR UPDATE
USING (auth.uid() = invited_user_id)
WITH CHECK (auth.uid() = invited_user_id);

CREATE POLICY "Davet edilen kullanıcı daveti silebilir."
ON public.lobby_invitations FOR DELETE
USING (auth.uid() = invited_user_id);


---
-- NOTIFICATIONS Tablosu Politikaları
---
ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Kullanıcılar sadece kendi bildirimlerini görebilir."
ON public.notifications FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Kullanıcılar kendi bildirimlerini güncelleyebilir (okundu olarak işaretleme)."
ON public.notifications FOR UPDATE
USING (auth.uid() = user_id);


---
-- TOURNAMENT_MATCHES Tablosu Politikaları
---
ALTER TABLE public.tournament_matches ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Herkes turnuva maçlarını görebilir."
ON public.tournament_matches FOR SELECT
USING (true);

CREATE POLICY "Giriş yapmış kullanıcılar turnuva maçları oluşturabilir."
ON public.tournament_matches FOR INSERT
WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Giriş yapmış kullanıcılar turnuva maçlarını güncelleyebilir."
ON public.tournament_matches FOR UPDATE
USING (auth.role() = 'authenticated')
WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Admin turnuva maçlarını silebilir."
ON public.tournament_matches FOR DELETE
USING (auth.role() = 'admin');


---
-- TOURNAMENT_PARTICIPANTS Tablosu Politikaları
---
ALTER TABLE public.tournament_participants ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Herkes turnuva katılımcılarını görebilir."
ON public.tournament_participants FOR SELECT
USING (true);

CREATE POLICY "Giriş yapmış kullanıcılar turnuvaya katılabilir."
ON public.tournament_participants FOR INSERT
WITH CHECK (auth.role() = 'authenticated' AND auth.uid() = user_id);

CREATE POLICY "Kullanıcılar kendi katılımlarını silebilir."
ON public.tournament_participants FOR DELETE
USING (auth.uid() = user_id);


---
-- TOURNAMENT_INVITATIONS Tablosu Politikaları
---
ALTER TABLE public.tournament_invitations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Kullanıcılar kendi davetlerini görebilir."
ON public.tournament_invitations FOR SELECT
USING (auth.uid() = invited_user_id OR auth.uid() = inviter_user_id);

CREATE POLICY "Giriş yapmış kullanıcılar davet gönderebilir."
ON public.tournament_invitations FOR INSERT
WITH CHECK (auth.role() = 'authenticated' AND auth.uid() = inviter_user_id);

CREATE POLICY "Davet edilen kullanıcı daveti yanıtlayabilir."
ON public.tournament_invitations FOR UPDATE
USING (auth.uid() = invited_user_id)
WITH CHECK (auth.uid() = invited_user_id);

CREATE POLICY "Davet edilen kullanıcı daveti silebilir."
ON public.tournament_invitations FOR DELETE
USING (auth.uid() = invited_user_id);


---
-- USER_GAME_PROFILES Tablosu Politikaları
---
ALTER TABLE public.user_game_profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Kullanıcılar kendi oyun profillerini görebilir."
ON public.user_game_profiles FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Kullanıcılar kendi oyun profillerini oluşturabilir."
ON public.user_game_profiles FOR INSERT
WITH CHECK (auth.role() = 'authenticated' AND auth.uid() = user_id);

CREATE POLICY "Kullanıcılar kendi oyun profillerini güncelleyebilir."
ON public.user_game_profiles FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Kullanıcılar kendi oyun profillerini silebilir."
ON public.user_game_profiles FOR DELETE
USING (auth.uid() = user_id);


---
-- GENEL AMAÇLI TABLOLAR İÇİN POLİTİKALAR
-- (games, tournaments, announcements, match_history vb.)
---

ALTER TABLE public.games ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Herkes oyunları görebilir." ON public.games FOR SELECT USING (true);
-- Genellikle oyun ekleme/güncelleme admin yetkisi gerektirir ve RLS yerine arayüzden yönetilir.

ALTER TABLE public.tournaments ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Herkes turnuvaları görebilir." ON public.tournaments FOR SELECT USING (true);

ALTER TABLE public.announcements ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Herkes duyuruları görebilir." ON public.announcements FOR SELECT USING (true);

ALTER TABLE public.match_history ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Herkes maç geçmişini görebilir." ON public.match_history FOR SELECT USING (true);

ALTER TABLE public.match_participants ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Herkes maç katılımcılarını görebilir." ON public.match_participants FOR SELECT USING (true);

ALTER TABLE public.match_sets ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Herkes set sonuçlarını görebilir." ON public.match_sets FOR SELECT USING (true);
CREATE POLICY "Giriş yapmış kullanıcılar set sonuçlarını ekleyebilir." ON public.match_sets FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Giriş yapmış kullanıcılar set sonuçlarını güncelleyebilir." ON public.match_sets FOR UPDATE USING (auth.role() = 'authenticated') WITH CHECK (auth.role() = 'authenticated');
